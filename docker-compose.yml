services:
  nanobots:
    build:
      context: .
      args:
        NANOBOTS_ENABLE_QMD: "true"
    container_name: nanobots
    environment:
      TZ: Asia/Singapore
      HOME: /home/node
      TERM: xterm-256color
      NANOBOTS_STATE_DIR: /home/node/.nanobots
      NANOBOTS_GATEWAY_TOKEN: ${NANOBOTS_GATEWAY_TOKEN:-changeme}
      OPENCLAW_BUNDLED_PLUGINS_DIR: /app/extensions
      NANOBOTS_GOOGLE_CLIENT_ID: ${NANOBOTS_GOOGLE_CLIENT_ID}
      NANOBOTS_GOOGLE_CLIENT_SECRET: ${NANOBOTS_GOOGLE_CLIENT_SECRET}
      NANOBOTS_TODOIST_CLIENT_ID: ${NANOBOTS_TODOIST_CLIENT_ID}
      NANOBOTS_TODOIST_CLIENT_SECRET: ${NANOBOTS_TODOIST_CLIENT_SECRET}
      NANOBOTS_NOTION_CLIENT_ID: ${NANOBOTS_NOTION_CLIENT_ID}
      NANOBOTS_NOTION_CLIENT_SECRET: ${NANOBOTS_NOTION_CLIENT_SECRET}
      NANOBOTS_GOOGLE_PLACES_API_KEY: ${NANOBOTS_GOOGLE_PLACES_API_KEY}
      NANOBOTS_AMAP_API_KEY: ${NANOBOTS_AMAP_API_KEY}
      NANOBOTS_OPENWEATHERMAP_API_KEY: ${NANOBOTS_OPENWEATHERMAP_API_KEY}
      NANOBOTS_AMADEUS_API_KEY: ${NANOBOTS_AMADEUS_API_KEY}
      NANOBOTS_AMADEUS_API_SECRET: ${NANOBOTS_AMADEUS_API_SECRET}
      NANOBOTS_EZBOOKKEEPING_URL: http://ezbookkeeping:8080
      NANOBOTS_EZBOOKKEEPING_SECRET: ${NANOBOTS_EZBOOKKEEPING_SECRET:-nanobots-ezb-secret}
      NANOBOTS_EZBOOKKEEPING_CURRENCY: ${NANOBOTS_EZBOOKKEEPING_CURRENCY:-SGD}
      CAMINO_API_KEY: ${CAMINO_API_KEY}
      NANOBOTS_USDA_API_KEY: ${NANOBOTS_USDA_API_KEY}
      NANOBOTS_DROPBOX_CLIENT_ID: ${NANOBOTS_DROPBOX_CLIENT_ID}
      NANOBOTS_DROPBOX_CLIENT_SECRET: ${NANOBOTS_DROPBOX_CLIENT_SECRET}
      NANOBOTS_MICROSOFT365_CLIENT_ID: ${NANOBOTS_MICROSOFT365_CLIENT_ID}
      NANOBOTS_MICROSOFT365_CLIENT_SECRET: ${NANOBOTS_MICROSOFT365_CLIENT_SECRET}
      NANOBOTS_GITHUB_CLIENT_ID: ${NANOBOTS_GITHUB_CLIENT_ID}
      NANOBOTS_GITHUB_CLIENT_SECRET: ${NANOBOTS_GITHUB_CLIENT_SECRET}
      NANOBOTS_MEMORY_BACKEND: qmd
      NANOBOTS_QMD_MODELS_DIR: /home/node/.nanobots/shared/qmd-models
      NANOBOTS_LILY_TELEGRAM_BOT_TOKEN: ${NANOBOTS_LILY_TELEGRAM_BOT_TOKEN:-}
      POSTIZ_URL: ${POSTIZ_URL:-http://postiz:5000}
      POSTIZ_EMAIL: ${POSTIZ_EMAIL:-}
      POSTIZ_PASSWORD: ${POSTIZ_PASSWORD:-}
    depends_on:
      ezbookkeeping:
        condition: service_started
    volumes:
      - nanobots-data:/home/node/.nanobots
      - nanobots-workspace:/home/node/.nanobots/workspace
      - qmd-models:/home/node/.nanobots/shared/qmd-models
      - ./skills:/app/skills
      - ./workspace-lily:/home/node/.nanobots/workspace-lily
    ports:
      - "${NANOBOTS_PORT:-8080}:8080"
    networks:
      - default
      - postiz-network
    init: true
    restart: unless-stopped

  # ===== Postiz 社交媒体管理平台 =====
  # 启动命令: docker compose --profile postiz up -d
  # Web UI: http://localhost:4007
  # 首次访问需注册账号，然后将 email/password 填入 .env 的 POSTIZ_EMAIL/POSTIZ_PASSWORD

  postiz:
    image: ghcr.io/gitroomhq/postiz-app:latest
    container_name: postiz
    profiles: ["postiz"]
    restart: unless-stopped
    environment:
      MAIN_URL: ${POSTIZ_MAIN_URL:-http://localhost:4007}
      FRONTEND_URL: ${POSTIZ_MAIN_URL:-http://localhost:4007}
      NEXT_PUBLIC_BACKEND_URL: ${POSTIZ_MAIN_URL:-http://localhost:4007}/api
      JWT_SECRET: ${POSTIZ_JWT_SECRET:-change-me-to-a-random-string}
      DATABASE_URL: postgresql://postiz:postiz@postiz-postgres:5432/postiz
      REDIS_URL: redis://postiz-redis:6379
      BACKEND_INTERNAL_URL: http://localhost:3000
      TEMPORAL_ADDRESS: temporal:7233
      IS_GENERAL: "true"
      DISABLE_REGISTRATION: "false"
      RUN_CRON: "true"
      STORAGE_PROVIDER: local
      UPLOAD_DIRECTORY: /uploads
      NEXT_PUBLIC_UPLOAD_DIRECTORY: /uploads
      # Social media OAuth keys (fill in .env as needed)
      X_API_KEY: ${POSTIZ_X_API_KEY:-}
      X_API_SECRET: ${POSTIZ_X_API_SECRET:-}
      LINKEDIN_CLIENT_ID: ${POSTIZ_LINKEDIN_CLIENT_ID:-}
      LINKEDIN_CLIENT_SECRET: ${POSTIZ_LINKEDIN_CLIENT_SECRET:-}
      FACEBOOK_APP_ID: ${POSTIZ_FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${POSTIZ_FACEBOOK_APP_SECRET:-}
      TIKTOK_CLIENT_ID: ${POSTIZ_TIKTOK_CLIENT_ID:-}
      TIKTOK_CLIENT_SECRET: ${POSTIZ_TIKTOK_CLIENT_SECRET:-}
      YOUTUBE_CLIENT_ID: ${POSTIZ_YOUTUBE_CLIENT_ID:-}
      YOUTUBE_CLIENT_SECRET: ${POSTIZ_YOUTUBE_CLIENT_SECRET:-}
      REDDIT_CLIENT_ID: ${POSTIZ_REDDIT_CLIENT_ID:-}
      REDDIT_CLIENT_SECRET: ${POSTIZ_REDDIT_CLIENT_SECRET:-}
      THREADS_APP_ID: ${POSTIZ_THREADS_APP_ID:-}
      THREADS_APP_SECRET: ${POSTIZ_THREADS_APP_SECRET:-}
      PINTEREST_CLIENT_ID: ${POSTIZ_PINTEREST_CLIENT_ID:-}
      PINTEREST_CLIENT_SECRET: ${POSTIZ_PINTEREST_CLIENT_SECRET:-}
      MASTODON_URL: https://mastodon.social
      MASTODON_CLIENT_ID: ${POSTIZ_MASTODON_CLIENT_ID:-}
      MASTODON_CLIENT_SECRET: ${POSTIZ_MASTODON_CLIENT_SECRET:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      NX_ADD_PLUGINS: "false"
    volumes:
      - postiz-config:/config/
      - postiz-uploads:/uploads/
    ports:
      - "${POSTIZ_PORT:-4007}:5000"
    networks:
      - postiz-network
    depends_on:
      postiz-postgres:
        condition: service_healthy
      postiz-redis:
        condition: service_healthy

  postiz-postgres:
    image: postgres:17-alpine
    container_name: postiz-postgres
    profiles: ["postiz"]
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: postiz
      POSTGRES_USER: postiz
      POSTGRES_DB: postiz
    volumes:
      - postiz-postgres-data:/var/lib/postgresql/data
    networks:
      - postiz-network
    healthcheck:
      test: pg_isready -U postiz -d postiz
      interval: 10s
      timeout: 3s
      retries: 3

  postiz-redis:
    image: redis:7.2
    container_name: postiz-redis
    profiles: ["postiz"]
    restart: unless-stopped
    volumes:
      - postiz-redis-data:/data
    networks:
      - postiz-network
    healthcheck:
      test: redis-cli ping
      interval: 10s
      timeout: 3s
      retries: 3

  temporal:
    image: temporalio/auto-setup:1.28.1
    container_name: temporal
    profiles: ["postiz"]
    restart: unless-stopped
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=temporal
      - POSTGRES_PWD=temporal
      - POSTGRES_SEEDS=temporal-postgresql
      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-sql.yaml
      - ENABLE_ES=true
      - ES_SEEDS=temporal-elasticsearch
      - ES_VERSION=v7
      - TEMPORAL_NAMESPACE=default
    volumes:
      - ./postiz/dynamicconfig:/etc/temporal/config/dynamicconfig
    networks:
      - postiz-network
    depends_on:
      - temporal-postgresql
      - temporal-elasticsearch

  temporal-postgresql:
    image: postgres:16
    container_name: temporal-postgresql
    profiles: ["postiz"]
    restart: unless-stopped
    environment:
      POSTGRES_PASSWORD: temporal
      POSTGRES_USER: temporal
    volumes:
      - temporal-postgres-data:/var/lib/postgresql/data
    networks:
      - postiz-network

  temporal-elasticsearch:
    image: elasticsearch:7.17.27
    container_name: temporal-elasticsearch
    profiles: ["postiz"]
    restart: unless-stopped
    environment:
      - cluster.routing.allocation.disk.threshold_enabled=true
      - cluster.routing.allocation.disk.watermark.low=512mb
      - cluster.routing.allocation.disk.watermark.high=256mb
      - cluster.routing.allocation.disk.watermark.flood_stage=128mb
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
      - xpack.security.enabled=false
    volumes:
      - temporal-es-data:/usr/share/elasticsearch/data
    networks:
      - postiz-network

  ezbookkeeping:
    image: mayswind/ezbookkeeping:latest
    container_name: ezbookkeeping
    environment:
      EBK_SERVER_HTTP_ADDR: "0.0.0.0"
      EBK_SERVER_HTTP_PORT: "8080"
      EBK_DATABASE_TYPE: "sqlite3"
      EBK_DATABASE_DB_PATH: "/ezbookkeeping/data/ezbookkeeping.db"
      EBK_SECURITY_SECRET_KEY: ${NANOBOTS_EZBOOKKEEPING_SECRET:-nanobots-ezb-secret}
      EBK_SECURITY_ENABLE_TWO_FACTOR: "false"
      EBK_USER_ENABLE_REGISTER: "true"
    volumes:
      - ezbookkeeping-data:/ezbookkeeping/data
    restart: unless-stopped

volumes:
  nanobots-data:
  nanobots-workspace:
  ezbookkeeping-data:
  qmd-models:
  postiz-config:
  postiz-uploads:
  postiz-postgres-data:
  postiz-redis-data:
  temporal-postgres-data:
  temporal-es-data:

networks:
  default:
  postiz-network:
